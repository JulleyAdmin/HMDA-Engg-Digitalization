<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMDA CSV Field-Level Feedback Collector</title>
    <link rel="stylesheet" href="shared/styles.css">
    <style>
        .feedback-collector {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .stage-selector {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .stage-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stage-btn {
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .stage-btn:hover {
            border-color: #1e3a8a;
            background: #eff6ff;
        }

        .stage-btn.active {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            border-color: #1e3a8a;
        }

        .csv-data-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .csv-header {
            background: #f3f4f6;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .csv-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .csv-stats {
            display: flex;
            gap: 20px;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .fields-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .fields-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
        }

        .fields-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }

        .fields-table tr:hover {
            background: #f8fafc;
        }

        .field-name {
            font-weight: 500;
            color: #1e293b;
            min-width: 150px;
        }

        .field-type {
            color: #059669;
            background: #f0fdf4;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .field-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-implemented {
            color: #059669;
        }

        .status-not-implemented {
            color: #ef4444;
        }

        .feedback-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-stars {
            display: flex;
            gap: 2px;
        }

        .star {
            color: #d1d5db;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.2s ease;
        }

        .star.filled {
            color: #f59e0b;
        }

        .star:hover {
            color: #f59e0b;
        }

        .feedback-input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            width: 100%;
            min-width: 150px;
        }

        .feedback-select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
        }

        .priority-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .priority-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-low {
            background: #f3f4f6;
            color: #6b7280;
        }

        .section-grouping {
            background: #eff6ff;
            color: #1e3a8a;
            font-weight: 600;
            padding: 8px 12px;
        }

        .export-controls {
            background: #f8fafc;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-export {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e3a8a;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .filters-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .hidden {
            display: none;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .feedback-summary {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #059669;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .implementation-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .impl-complete {
            background: #dcfce7;
            color: #166534;
        }

        .impl-partial {
            background: #fef3c7;
            color: #92400e;
        }

        .impl-missing {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>HMDA CSV Field-Level Feedback Collector</h1>
                <p class="subtitle">Comprehensive Field Analysis & Requirements Feedback System</p>
            </div>
        </header>

        <!-- Main Content -->
        <div class="feedback-collector">
            <!-- Stage Selection -->
            <div class="stage-selector">
                <h3>Select Stage for Field-Level Feedback</h3>
                <p>Choose a stage to review its field definitions and provide detailed feedback on requirements, implementations, and improvements.</p>
                
                <div class="stage-buttons">
                    <div class="stage-btn" data-stage="1">
                        <div>Stage 1</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Conceptualization</div>
                    </div>
                    <div class="stage-btn" data-stage="2">
                        <div>Stage 2</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">DPR & Approvals</div>
                    </div>
                    <div class="stage-btn" data-stage="3">
                        <div>Stage 3</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Tendering</div>
                    </div>
                    <div class="stage-btn" data-stage="4">
                        <div>Stage 4</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Contract Award</div>
                    </div>
                    <div class="stage-btn" data-stage="5">
                        <div>Stage 5</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Execution</div>
                    </div>
                    <div class="stage-btn" data-stage="6">
                        <div>Stage 6</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Quality Control</div>
                    </div>
                    <div class="stage-btn" data-stage="7">
                        <div>Stage 7</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Testing</div>
                    </div>
                    <div class="stage-btn" data-stage="8">
                        <div>Stage 8</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">Closure</div>
                    </div>
                    <div class="stage-btn" data-stage="9">
                        <div>Stage 9</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">DLP & O&M</div>
                    </div>
                </div>
            </div>

            <!-- Feedback Summary -->
            <div class="feedback-summary hidden" id="feedbackSummary">
                <h3>📊 Field Analysis Summary</h3>
                <div class="summary-stats" id="summaryStats">
                    <!-- Dynamic stats will be inserted here -->
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-section hidden" id="filtersSection">
                <h4>🔍 Filter & Search Fields</h4>
                <div class="filter-controls">
                    <div>
                        <label>Search Fields:</label>
                        <input type="text" id="searchFields" class="feedback-input" placeholder="Search field names, descriptions...">
                    </div>
                    <div>
                        <label>Filter by Section:</label>
                        <select id="filterSection" class="feedback-select">
                            <option value="">All Sections</option>
                        </select>
                    </div>
                    <div>
                        <label>Filter by Implementation:</label>
                        <select id="filterImplementation" class="feedback-select">
                            <option value="">All Fields</option>
                            <option value="✓ Implemented">Implemented</option>
                            <option value="Not Implemented">Not Implemented</option>
                        </select>
                    </div>
                    <div>
                        <label>Filter by Priority:</label>
                        <select id="filterPriority" class="feedback-select">
                            <option value="">All Priorities</option>
                            <option value="high">High Priority</option>
                            <option value="medium">Medium Priority</option>
                            <option value="low">Low Priority</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- CSV Data Container -->
            <div class="csv-data-container hidden" id="csvContainer">
                <div class="csv-header">
                    <div class="csv-title" id="csvTitle">Stage Fields Analysis</div>
                    <div class="csv-stats" id="csvStats">
                        <!-- Dynamic stats -->
                    </div>
                </div>

                <div class="table-container">
                    <table class="fields-table" id="fieldsTable">
                        <!-- Dynamic table content -->
                    </table>
                </div>

                <div class="export-controls">
                    <div>
                        <strong>Export Options:</strong>
                    </div>
                    <div class="export-buttons">
                        <button class="btn-export btn-secondary" onclick="exportToCSV()">📊 Export CSV</button>
                        <button class="btn-export btn-primary" onclick="exportFeedbackReport()">📄 Export Feedback Report</button>
                        <button class="btn-export btn-success" onclick="exportActionPlan()">📋 Export Action Plan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStage = null;
        let currentData = [];
        let filteredData = [];
        
        // CSV file paths for each stage
        const stageFiles = {
            1: 'csv-field-definitions/stage1-fields.csv',
            2: 'csv-field-definitions/stage2-fields.csv',
            3: 'csv-field-definitions/stage3-fields.csv',
            4: 'csv-field-definitions/stage4-fields.csv',
            5: 'csv-field-definitions/stage5-fields.csv',
            6: 'csv-field-definitions/stage6-fields.csv',
            7: 'csv-field-definitions/stage7-fields.csv',
            8: 'csv-field-definitions/stage8-fields.csv',
            9: 'csv-field-definitions/stage9-fields.csv'
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Stage button clicks
            document.querySelectorAll('.stage-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stage = this.dataset.stage;
                    selectStage(stage);
                });
            });

            // Filter controls
            document.getElementById('searchFields').addEventListener('input', applyFilters);
            document.getElementById('filterSection').addEventListener('change', applyFilters);
            document.getElementById('filterImplementation').addEventListener('change', applyFilters);
            document.getElementById('filterPriority').addEventListener('change', applyFilters);
        }

        async function selectStage(stageNumber) {
            currentStage = stageNumber;
            
            // Update active stage button
            document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-stage="${stageNumber}"]`).classList.add('active');
            
            // Load CSV data for the selected stage
            await loadStageData(stageNumber);
        }

        async function loadStageData(stageNumber) {
            try {
                // For demo purposes, we'll use sample data
                // In real implementation, you would fetch from actual CSV files
                currentData = await generateSampleData(stageNumber);
                filteredData = [...currentData];
                
                updateUI();
                showDataContainer();
            } catch (error) {
                console.error('Error loading stage data:', error);
                alert('Error loading stage data. Please try again.');
            }
        }

        async function generateSampleData(stageNumber) {
            // Sample data based on our CSV structure
            const stageNames = {
                1: 'Project Conceptualization',
                2: 'DPR & Approvals', 
                3: 'Tendering & Procurement',
                4: 'Contract Award & Mobilization',
                5: 'Construction/Execution',
                6: 'Quality Control & Monitoring',
                7: 'Testing & Commissioning',
                8: 'Project Closure & Handover',
                9: 'DLP & O&M Phase'
            };

            // This would normally parse actual CSV data
            // For demo, returning structured sample data
            return await fetch(stageFiles[stageNumber])
                .then(response => response.text())
                .then(csvText => parseCSV(csvText))
                .catch(error => {
                    console.log('CSV file not found, using sample data');
                    return getSampleDataForStage(stageNumber);
                });
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }

            return data;
        }

        function getSampleDataForStage(stageNumber) {
            // Sample data structure matching our CSV format
            const sampleData = [
                {
                    stage_id: stageNumber,
                    form_section: 'Basic Project Information',
                    field_id: 'projectName',
                    field_name: 'Project Name',
                    field_type: 'text',
                    validation_rules: 'required maxlength=500',
                    required_status: 'required',
                    possible_values: 'free_text',
                    dependencies: 'none',
                    help_text: 'Descriptive project name',
                    current_implementation: '✓ Implemented',
                    feedback_category: 'validation',
                    user_rating: '',
                    user_comments: '',
                    improvement_suggestions: '',
                    priority_level: 'high'
                },
                {
                    stage_id: stageNumber,
                    form_section: 'Basic Project Information',
                    field_id: 'projectCategory',
                    field_name: 'Project Category',
                    field_type: 'select',
                    validation_rules: 'required',
                    required_status: 'required',
                    possible_values: 'Infrastructure,Layout Development,Water Supply',
                    dependencies: 'controls_projectType',
                    help_text: 'Primary category classification',
                    current_implementation: '✓ Implemented',
                    feedback_category: 'field_design',
                    user_rating: '',
                    user_comments: '',
                    improvement_suggestions: '',
                    priority_level: 'high'
                },
                {
                    stage_id: stageNumber,
                    form_section: 'Financial Estimates',
                    field_id: 'preliminaryEstimate',
                    field_name: 'Preliminary Estimate (₹ Lakhs)',
                    field_type: 'number',
                    validation_rules: 'required step=0.01 min=0',
                    required_status: 'required',
                    possible_values: 'numeric_positive',
                    dependencies: 'basis_for_calculations',
                    help_text: 'Initial cost estimate in lakhs',
                    current_implementation: '✓ Implemented',
                    feedback_category: 'validation',
                    user_rating: '',
                    user_comments: '',
                    improvement_suggestions: '',
                    priority_level: 'high'
                }
            ];

            return sampleData;
        }

        function updateUI() {
            updateSummaryStats();
            updateFilters();
            renderFieldsTable();
            updateCSVStats();
        }

        function updateSummaryStats() {
            const totalFields = currentData.length;
            const implementedFields = currentData.filter(f => f.current_implementation === '✓ Implemented').length;
            const highPriorityFields = currentData.filter(f => f.priority_level === 'high').length;
            const sectionsCount = [...new Set(currentData.map(f => f.form_section))].length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalFields}</div>
                    <div class="stat-label">Total Fields</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${implementedFields}</div>
                    <div class="stat-label">Implemented</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${sectionsCount}</div>
                    <div class="stat-label">Form Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${highPriorityFields}</div>
                    <div class="stat-label">High Priority</div>
                </div>
            `;

            document.getElementById('summaryStats').innerHTML = statsHTML;
        }

        function updateFilters() {
            // Update section filter
            const sections = [...new Set(currentData.map(f => f.form_section))];
            const sectionSelect = document.getElementById('filterSection');
            sectionSelect.innerHTML = '<option value="">All Sections</option>';
            sections.forEach(section => {
                sectionSelect.innerHTML += `<option value="${section}">${section}</option>`;
            });
        }

        function renderFieldsTable() {
            const tableHTML = `
                <thead>
                    <tr>
                        <th>Field Name</th>
                        <th>Type</th>
                        <th>Required</th>
                        <th>Implementation</th>
                        <th>Priority</th>
                        <th>Rating</th>
                        <th>Comments</th>
                        <th>Suggestions</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody>
                    ${generateTableRows()}
                </tbody>
            `;

            document.getElementById('fieldsTable').innerHTML = tableHTML;
        }

        function generateTableRows() {
            let currentSection = '';
            let rows = '';

            filteredData.forEach((field, index) => {
                // Add section header if it's a new section
                if (field.form_section !== currentSection) {
                    currentSection = field.form_section;
                    rows += `
                        <tr>
                            <td colspan="9" class="section-grouping">
                                📋 ${currentSection}
                            </td>
                        </tr>
                    `;
                }

                rows += `
                    <tr data-field-id="${field.field_id}">
                        <td>
                            <div class="field-name">${field.field_name}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${field.field_id}</div>
                        </td>
                        <td>
                            <span class="field-type">${field.field_type}</span>
                        </td>
                        <td>
                            ${field.required_status === 'required' ? 
                                '<span style="color: #ef4444;">Required</span>' : 
                                '<span style="color: #6b7280;">Optional</span>'
                            }
                        </td>
                        <td>
                            <span class="implementation-status ${getImplementationClass(field.current_implementation)}">
                                ${field.current_implementation}
                            </span>
                        </td>
                        <td>
                            <span class="priority-badge priority-${field.priority_level}">
                                ${field.priority_level.toUpperCase()}
                            </span>
                        </td>
                        <td>
                            <div class="rating-stars" data-field="${field.field_id}">
                                ${generateStars(field.user_rating || 0)}
                            </div>
                        </td>
                        <td>
                            <input type="text" class="feedback-input" 
                                   placeholder="Your feedback..." 
                                   value="${field.user_comments || ''}"
                                   onchange="updateFieldFeedback('${field.field_id}', 'comments', this.value)">
                        </td>
                        <td>
                            <input type="text" class="feedback-input" 
                                   placeholder="Suggestions..." 
                                   value="${field.improvement_suggestions || ''}"
                                   onchange="updateFieldFeedback('${field.field_id}', 'suggestions', this.value)">
                        </td>
                        <td>
                            <select class="feedback-select" 
                                    onchange="updateFieldFeedback('${field.field_id}', 'category', this.value)">
                                <option value="">Select...</option>
                                <option value="field_design" ${field.feedback_category === 'field_design' ? 'selected' : ''}>Field Design</option>
                                <option value="validation" ${field.feedback_category === 'validation' ? 'selected' : ''}>Validation</option>
                                <option value="functionality" ${field.feedback_category === 'functionality' ? 'selected' : ''}>Functionality</option>
                                <option value="data_flow" ${field.feedback_category === 'data_flow' ? 'selected' : ''}>Data Flow</option>
                                <option value="calculation" ${field.feedback_category === 'calculation' ? 'selected' : ''}>Calculation</option>
                            </select>
                        </td>
                    </tr>
                `;
            });

            return rows;
        }

        function getImplementationClass(implementation) {
            if (implementation === '✓ Implemented') return 'impl-complete';
            if (implementation === 'Partially Implemented') return 'impl-partial';
            return 'impl-missing';
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i <= rating ? 'filled' : ''}" 
                               onclick="setRating('${i}', event)" 
                               data-rating="${i}">⭐</span>`;
            }
            return stars;
        }

        function setRating(rating, event) {
            const fieldId = event.target.closest('.rating-stars').dataset.field;
            const stars = event.target.closest('.rating-stars').querySelectorAll('.star');
            
            // Update visual stars
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });

            // Update data
            updateFieldFeedback(fieldId, 'rating', rating);
        }

        function updateFieldFeedback(fieldId, type, value) {
            const field = currentData.find(f => f.field_id === fieldId);
            if (field) {
                switch (type) {
                    case 'rating':
                        field.user_rating = value;
                        break;
                    case 'comments':
                        field.user_comments = value;
                        break;
                    case 'suggestions':
                        field.improvement_suggestions = value;
                        break;
                    case 'category':
                        field.feedback_category = value;
                        break;
                }
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFields').value.toLowerCase();
            const sectionFilter = document.getElementById('filterSection').value;
            const implementationFilter = document.getElementById('filterImplementation').value;
            const priorityFilter = document.getElementById('filterPriority').value;

            filteredData = currentData.filter(field => {
                const matchesSearch = !searchTerm || 
                    field.field_name.toLowerCase().includes(searchTerm) ||
                    field.help_text.toLowerCase().includes(searchTerm) ||
                    field.form_section.toLowerCase().includes(searchTerm);

                const matchesSection = !sectionFilter || field.form_section === sectionFilter;
                const matchesImplementation = !implementationFilter || field.current_implementation === implementationFilter;
                const matchesPriority = !priorityFilter || field.priority_level === priorityFilter;

                return matchesSearch && matchesSection && matchesImplementation && matchesPriority;
            });

            renderFieldsTable();
            updateCSVStats();
        }

        function updateCSVStats() {
            const stats = `
                Total Fields: ${filteredData.length} | 
                Implemented: ${filteredData.filter(f => f.current_implementation === '✓ Implemented').length} |
                High Priority: ${filteredData.filter(f => f.priority_level === 'high').length}
            `;
            document.getElementById('csvStats').textContent = stats;
        }

        function showDataContainer() {
            document.getElementById('csvContainer').classList.remove('hidden');
            document.getElementById('feedbackSummary').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            
            const stageName = document.querySelector(`[data-stage="${currentStage}"]`).textContent.trim();
            document.getElementById('csvTitle').textContent = `${stageName} - Field Analysis & Feedback`;
        }

        function exportToCSV() {
            const csvContent = generateCSVContent();
            downloadFile(csvContent, `HMDA-Stage${currentStage}-Fields-Feedback.csv`, 'text/csv');
        }

        function generateCSVContent() {
            const headers = [
                'stage_id', 'form_section', 'field_id', 'field_name', 'field_type',
                'validation_rules', 'required_status', 'possible_values', 'dependencies',
                'help_text', 'current_implementation', 'feedback_category', 'user_rating',
                'user_comments', 'improvement_suggestions', 'priority_level'
            ];

            let csv = headers.join(',') + '\n';

            currentData.forEach(field => {
                const row = headers.map(header => {
                    const value = field[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csv += row.join(',') + '\n';
            });

            return csv;
        }

        function exportFeedbackReport() {
            const reportHTML = generateFeedbackReport();
            downloadFile(reportHTML, `HMDA-Stage${currentStage}-Feedback-Report.html`, 'text/html');
        }

        function generateFeedbackReport() {
            const stageName = document.querySelector(`[data-stage="${currentStage}"]`).textContent.trim();
            const implementedCount = currentData.filter(f => f.current_implementation === '✓ Implemented').length;
            const totalCount = currentData.length;
            const implementationRate = ((implementedCount / totalCount) * 100).toFixed(1);

            const feedbackFields = currentData.filter(f => f.user_comments || f.user_rating > 0 || f.improvement_suggestions);

            return `
<!DOCTYPE html>
<html>
<head>
    <title>HMDA ${stageName} - Field Feedback Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { background: #1e3a8a; color: white; padding: 20px; text-align: center; border-radius: 8px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .stat { display: inline-block; margin: 10px 20px; }
        .field-feedback { background: #f8fafc; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .high-priority { border-left: 4px solid #ef4444; }
        .medium-priority { border-left: 4px solid #f59e0b; }
        .low-priority { border-left: 4px solid #6b7280; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background: #f3f4f6; }
    </style>
</head>
<body>
    <div class="header">
        <h1>HMDA Field-Level Feedback Report</h1>
        <h2>${stageName}</h2>
        <p>Generated: ${new Date().toLocaleDateString()}</p>
    </div>

    <div class="section">
        <h3>📊 Implementation Summary</h3>
        <div class="stat"><strong>Total Fields:</strong> ${totalCount}</div>
        <div class="stat"><strong>Implemented:</strong> ${implementedCount} (${implementationRate}%)</div>
        <div class="stat"><strong>Feedback Provided:</strong> ${feedbackFields.length}</div>
    </div>

    <div class="section">
        <h3>💬 Field Feedback Details</h3>
        ${feedbackFields.map(field => `
            <div class="field-feedback ${field.priority_level}-priority">
                <h4>${field.field_name} (${field.field_id})</h4>
                <p><strong>Section:</strong> ${field.form_section}</p>
                <p><strong>Implementation:</strong> ${field.current_implementation}</p>
                <p><strong>Priority:</strong> ${field.priority_level.toUpperCase()}</p>
                ${field.user_rating ? `<p><strong>Rating:</strong> ${'⭐'.repeat(field.user_rating)} (${field.user_rating}/5)</p>` : ''}
                ${field.user_comments ? `<p><strong>Comments:</strong> ${field.user_comments}</p>` : ''}
                ${field.improvement_suggestions ? `<p><strong>Suggestions:</strong> ${field.improvement_suggestions}</p>` : ''}
            </div>
        `).join('')}
    </div>

    <div class="section">
        <h3>📋 Action Items</h3>
        <ul>
            ${currentData.filter(f => f.current_implementation === 'Not Implemented' && f.priority_level === 'high')
                .map(f => `<li><strong>High Priority:</strong> Implement ${f.field_name} (${f.field_id})</li>`).join('')}
            ${feedbackFields.filter(f => f.improvement_suggestions)
                .map(f => `<li><strong>Enhancement:</strong> ${f.field_name} - ${f.improvement_suggestions}</li>`).join('')}
        </ul>
    </div>
</body>
</html>
            `;
        }

        function exportActionPlan() {
            const actionPlan = generateActionPlan();
            downloadFile(actionPlan, `HMDA-Stage${currentStage}-Action-Plan.md`, 'text/markdown');
        }

        function generateActionPlan() {
            const stageName = document.querySelector(`[data-stage="${currentStage}"]`).textContent.trim();
            const highPriorityItems = currentData.filter(f => f.priority_level === 'high' && f.current_implementation === 'Not Implemented');
            const enhancementItems = currentData.filter(f => f.improvement_suggestions);

            return `# HMDA ${stageName} - Implementation Action Plan

## 🎯 High Priority Implementation Tasks

${highPriorityItems.map((item, index) => `
### ${index + 1}. ${item.field_name}
- **Field ID:** ${item.field_id}
- **Section:** ${item.form_section}
- **Type:** ${item.field_type}
- **Requirements:** ${item.validation_rules}
- **Help Text:** ${item.help_text}
- **Dependencies:** ${item.dependencies}

**Action Required:** Implement this field with proper validation and integration.

`).join('')}

## 🔧 Enhancement Recommendations

${enhancementItems.map((item, index) => `
### ${index + 1}. ${item.field_name}
- **Current Status:** ${item.current_implementation}
- **Suggestion:** ${item.improvement_suggestions}
- **Priority:** ${item.priority_level.toUpperCase()}

`).join('')}

## 📈 Implementation Progress Tracking

- [ ] High Priority Fields (${highPriorityItems.length} items)
- [ ] Medium Priority Fields 
- [ ] Enhancement Items (${enhancementItems.length} items)
- [ ] Testing & Validation
- [ ] Documentation Update

## 📅 Timeline

**Phase 1 (Week 1-2):** High Priority Implementation
**Phase 2 (Week 3-4):** Medium Priority & Enhancements  
**Phase 3 (Week 5):** Testing & Documentation

Generated: ${new Date().toLocaleDateString()}
`;
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>